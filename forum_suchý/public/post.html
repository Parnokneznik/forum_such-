<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="post-details">
            <h1 id="post-title"></h1>
            <p id="post-content"></p>
            <p class="created-at" id="post-created-at"></p>
        </div>

        <div class="comment-form">
            <h2>Add New Comment</h2>
            <form id="new-comment-form">
                <input type="hidden" id="parent-comment-id" name="parentCommentId">
                <div>
                    <label for="comment-content">Comment:</label>
                    <textarea id="comment-content" name="content" rows="3" required></textarea>
                </div>
                <button type="submit">Comment</button>
            </form>
        </div>

        <div class="comments-section">
            <h2>Comments</h2>
            <ul id="comments">
                
            </ul>
        </div>

        <button id="back-to-home">Back to Home</button>
    </div>

    <script>
        const postId = new URLSearchParams(window.location.search).get('id');
        const postTitleElement = document.getElementById('post-title');
        const postContentElement = document.getElementById('post-content');
        const postCreatedAtElement = document.getElementById('post-created-at');
        const commentsListElement = document.getElementById('comments');
        const newCommentForm = document.getElementById('new-comment-form');
        const parentCommentIdInput = document.getElementById('parent-comment-id');
        const commentContentInput = document.getElementById('comment-content');
        const backToHomeButton = document.getElementById('back-to-home');

        function renderComment(comment, indent = 0) {
            const listItem = document.createElement('li');
            listItem.style.marginLeft = `${indent * 20}px`;
            listItem.innerHTML = `<p>${comment.content} <span class="created-at">(${new Date(comment.created_at).toLocaleString()})</span></p>
                                <button class="reply-button" data-parent-id="${comment.comment_id}">Reply</button>
                                <ul id="replies-${comment.comment_id}"></ul>`;
            commentsListElement.appendChild(listItem);

            const replyButton = listItem.querySelector('.reply-button');
            replyButton.addEventListener('click', function() {
                parentCommentIdInput.value = this.dataset.parentId;
                commentContentInput.focus();
            });

            if (comment.replies && comment.replies.length > 0) {
                const repliesList = document.getElementById(`replies-${comment.comment_id}`);
                comment.replies.forEach(reply => {
                    const replyItem = renderComment(reply, indent + 1);
                    repliesList.appendChild(replyItem);
                });
            }
            return listItem;
        }

        function loadPostAndComments() {
            fetch(`/api/posts/${postId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const { post, comments } = data;
                    postTitleElement.textContent = post.title;
                    postContentElement.textContent = post.content;
                    postCreatedAtElement.textContent = new Date(post.created_at).toLocaleString();
                    comments.forEach(comment => renderComment(comment));
                })
                .catch(error => {
                    console.error('Could not load post and comments:', error);
                    postTitleElement.textContent = 'Error loading post.';
                });
        }

        newCommentForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const content = commentContentInput.value;
            const parentCommentId = parentCommentIdInput.value || null;

            fetch(`/api/posts/${postId}/comments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ content, parentCommentId }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                commentContentInput.value = '';
                parentCommentIdInput.value = '';
                commentsListElement.innerHTML = ''; 
                loadPostAndComments();
            })
            .catch(error => {
                console.error('Could not add comment:', error);
            });
        });

        backToHomeButton.addEventListener('click', () => {
            window.location.href = '/';
        });

        loadPostAndComments();
    </script>
</body>
</html>